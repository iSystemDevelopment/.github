name: 'Automated Bug Fix Assistant'

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to attempt fix'
        required: true
        type: number
      fix_type:
        description: 'Type of automated fix to attempt'
        required: true
        type: choice
        options:
          - 'dependency-update'
          - 'security-patch'
          - 'linting-fix'
          - 'formatting-fix'
          - 'test-fix'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  analyze-bug:
    name: Analyze Bug for Auto-Fix
    runs-on: ubuntu-latest
    
    outputs:
      can-autofix: ${{ steps.analysis.outputs.can-autofix }}
      fix-strategy: ${{ steps.analysis.outputs.fix-strategy }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Get Issue Details
        id: get-issue
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.issue_number }}
            });
            
            core.setOutput('title', issue.data.title);
            core.setOutput('body', issue.data.body);
            core.setOutput('labels', JSON.stringify(issue.data.labels));
            
            return issue.data;

      - name: Analyze Fix Feasibility
        id: analysis
        run: |
          echo "Analyzing bug #${{ inputs.issue_number }} for automated fix..."
          
          FIX_TYPE="${{ inputs.fix_type }}"
          CAN_AUTOFIX="false"
          FIX_STRATEGY="manual"
          
          case "$FIX_TYPE" in
            "dependency-update")
              echo "‚úì Dependency updates can be automated"
              CAN_AUTOFIX="true"
              FIX_STRATEGY="dependency-update"
              ;;
            "security-patch")
              echo "‚úì Security patches can be automated via Dependabot"
              CAN_AUTOFIX="true"
              FIX_STRATEGY="security-patch"
              ;;
            "linting-fix")
              echo "‚úì Linting issues can be auto-fixed"
              CAN_AUTOFIX="true"
              FIX_STRATEGY="linting-fix"
              ;;
            "formatting-fix")
              echo "‚úì Formatting issues can be auto-fixed"
              CAN_AUTOFIX="true"
              FIX_STRATEGY="formatting-fix"
              ;;
            "test-fix")
              echo "‚ö† Test fixes require manual intervention"
              CAN_AUTOFIX="false"
              FIX_STRATEGY="manual"
              ;;
            *)
              echo "‚ö† Unknown fix type"
              CAN_AUTOFIX="false"
              FIX_STRATEGY="manual"
              ;;
          esac
          
          echo "can-autofix=$CAN_AUTOFIX" >> $GITHUB_OUTPUT
          echo "fix-strategy=$FIX_STRATEGY" >> $GITHUB_OUTPUT

  attempt-fix:
    name: Attempt Automated Fix
    runs-on: ubuntu-latest
    needs: analyze-bug
    if: needs.analyze-bug.outputs.can-autofix == 'true'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: '20'

      - name: Apply Fix Based on Strategy
        id: apply-fix
        run: |
          STRATEGY="${{ needs.analyze-bug.outputs.fix-strategy }}"
          
          echo "Applying fix strategy: $STRATEGY"
          
          case "$STRATEGY" in
            "dependency-update")
              echo "Running dependency updates..."
              if [ -f "package.json" ]; then
                npm update || echo "npm update completed with warnings"
              fi
              if [ -f "requirements.txt" ]; then
                echo "Python dependencies should be updated via Dependabot"
              fi
              ;;
            "linting-fix")
              echo "Running linting auto-fix..."
              if [ -f "package.json" ]; then
                npm install
                npm run lint -- --fix || echo "Linting applied"
              fi
              ;;
            "formatting-fix")
              echo "Running formatting auto-fix..."
              if [ -f "package.json" ]; then
                npm install
                npx prettier --write . || echo "Formatting applied"
              fi
              ;;
          esac
          
          # Check if there are changes
          if git diff --quiet; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request with Fix
        if: steps.apply-fix.outputs.has-changes == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const issueNumber = ${{ inputs.issue_number }};
            const fixType = '${{ inputs.fix_type }}';
            
            // Configure git
            await exec.exec('git', ['config', 'user.name', 'github-actions[bot]']);
            await exec.exec('git', ['config', 'user.email', 'github-actions[bot]@users.noreply.github.com']);
            
            // Create branch
            const branchName = `autofix/issue-${issueNumber}-${Date.now()}`;
            await exec.exec('git', ['checkout', '-b', branchName]);
            
            // Commit changes
            await exec.exec('git', ['add', '.']);
            await exec.exec('git', ['commit', '-m', `Automated fix for issue #${issueNumber}: ${fixType}`]);
            
            // Push branch
            await exec.exec('git', ['push', 'origin', branchName]);
            
            // Create PR
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ü§ñ Automated fix for #${issueNumber}`,
              head: branchName,
              base: 'main',
              body: `
              ## Automated Fix
              
              This PR contains an automated fix for issue #${issueNumber}.
              
              **Fix Type:** ${fixType}
              **Generated by:** GitHub Actions Bug Fix Assistant
              
              ### Changes
              - Applied automated ${fixType} fixes
              
              ### Testing
              Please review the changes and test thoroughly before merging.
              
              Closes #${issueNumber}
              `
            });
            
            console.log(`Created PR #${pr.data.number}`);

  report-results:
    name: Report Fix Results
    runs-on: ubuntu-latest
    needs: [analyze-bug, attempt-fix]
    if: always()
    
    steps:
      - name: Post Results to Issue
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const issueNumber = ${{ inputs.issue_number }};
            const canAutofix = '${{ needs.analyze-bug.outputs.can-autofix }}';
            const fixStrategy = '${{ needs.analyze-bug.outputs.fix-strategy }}';
            const attemptStatus = '${{ needs.attempt-fix.result }}';
            
            let comment = `## ü§ñ Automated Fix Report\n\n`;
            comment += `**Issue:** #${issueNumber}\n`;
            comment += `**Fix Type:** ${{ inputs.fix_type }}\n`;
            comment += `**Analysis:** ${canAutofix === 'true' ? '‚úÖ Auto-fix available' : '‚ö†Ô∏è Manual fix required'}\n`;
            comment += `**Strategy:** ${fixStrategy}\n\n`;
            
            if (canAutofix === 'true') {
              if (attemptStatus === 'success') {
                comment += `### ‚úÖ Fix Applied Successfully\n\n`;
                comment += `An automated fix has been attempted and a pull request has been created.\n`;
                comment += `Please review the PR and test the changes before merging.\n`;
              } else if (attemptStatus === 'failure') {
                comment += `### ‚ùå Fix Attempt Failed\n\n`;
                comment += `The automated fix could not be completed. Manual intervention required.\n`;
              } else {
                comment += `### ‚è≠Ô∏è Fix Skipped\n\n`;
                comment += `No changes were needed or fix was not applicable.\n`;
              }
            } else {
              comment += `### üìù Manual Fix Required\n\n`;
              comment += `This issue cannot be automatically fixed and requires manual intervention.\n`;
              comment += `Please review the issue and implement a fix manually.\n`;
            }
            
            comment += `\n---\n`;
            comment += `*This report was generated by the Automated Bug Fix Assistant workflow.*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });
